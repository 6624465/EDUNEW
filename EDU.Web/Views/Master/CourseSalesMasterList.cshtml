@using System.Globalization;
@model IEnumerable<EZY.EDU.Contract.CourseSalesMasterViewModel>
@{
    ViewBag.Title = "CourseSalesMasterList";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var ProductData = (List<EZY.EDU.Contract.EduProduct>)ViewData["ProductList"];
    var count = 0;

    var totalrevenue = 0;

    var totalRevenueArray = new List<Decimal>();

}
@functions {
    public string GetMonthById(int id)
    {
        var monthData = DateTimeFormatInfo.CurrentInfo.MonthNames.ToList();

        var month = id == 0 ? null : monthData[id - 1];
        return month;
    }

    public string CheckString(string remarks)
    {
        return remarks.Replace(System.Environment.NewLine, "<br/>");
    }

    public string ConvertToInt64dollar(decimal? data)
    {
        if (data != null && data > 0)
            return new HtmlString("$ " + Convert.ToInt64(data.Value)).ToString();
        else
            return null;
    }

}
@{
    var listMonths = new List<SelectListItem>()
                                          {
                                           new SelectListItem {Text = "All",   Value = "0"},
                                           new SelectListItem {Text = "January",   Value = "1"},
                                           new SelectListItem {Text = "February", Value = "2"},
                                           new SelectListItem {Text = "March", Value = "3"},
                                           new SelectListItem {Text = "April",   Value = "4"},
                                           new SelectListItem {Text = "May", Value = "5"},
                                           new SelectListItem {Text = "June", Value = "6"},
                                           new SelectListItem {Text = "July",   Value = "7"},
                                           new SelectListItem {Text = "August", Value = "8"},
                                           new SelectListItem {Text = "September", Value = "9"},
                                           new SelectListItem {Text = "October",   Value = "10"},
                                           new SelectListItem {Text = "November", Value = "11"},
                                           new SelectListItem {Text = "December", Value = "12"}
                                       };
}
<style>
    .bordertop {
        border-top: 2px solid gray !important;
        border-bottom: 2px solid gray !important;
        color: #D73925;
        /*font-family: 'Bebas Neue'*/
    }

    .popover {
        color: black;
        min-width: 500px;
    }

    .popover-title {
        background-color: #F7F7F7;
        border-bottom: 1px solid #EBEBEB;
        border-radius: 5px 5px 0 0;
        font-size: 15px;
        font-weight: bold;
        line-height: 18px;
        margin: 0;
        padding: 8px 14px;
    }

    .center {
        text-align: center !important;
    }

    .action {
        width: 50px;
    }
</style>

<div class="page">
    <div class="page-wrap">
        <div class="panel panel-default">
            <div class="box" id="grid">
                <div class="box-header">
                    <h4>Regional Leads List</h4>
                    <div class="box-tools">
                        @if (Session["RoleCode"].ToString() == "ADMIN" || Session["RoleCode"].ToString() == "SALES" || Session["RoleCode"].ToString() == "REGIONAL")
                        {
                            <button type="button" class="btn btn-info btn-sm waves-effect" data-toggle="modal" onclick="navigateToDetail(-1)"><i class="fa fa-plus"></i>Add New Regional Lead</button>
                        }
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="form-group">
                            <label class="col-md-1 control-label">
                                <span class="pull-right">Year</span>
                            </label>
                            <div class="col-md-1">
                                @Html.DropDownListFor(x => x.FirstOrDefault().Year, Enumerable.Range(2014, 14).Select(i => new SelectListItem { Text = i.ToString(), Value = i.ToString() }), new { @class = "form-control input-sm", onchange = "ChangeMonth();" })
                            </div>
                            <label class="col-md-1 control-label">
                                <span class="pull-right">Month</span>
                            </label>
                            <div class="col-md-2">
                                @Html.DropDownListFor(x => x.FirstOrDefault().Month, listMonths, new { @class = "form-control input-sm", onchange = "ChangeMonth();" })
                            </div>
                        </div>
                    </div>
                    <div class="row css25">
                        <div class="col-md-12">
                            <div class="clearfix tabs-linearrow">
                                <ul class="nav nav-tabs">
                                    @for (int i = 0; i < ProductData.Count(); i++)
                                    {
                                        <li id="li_@i"><a href="#div_@i" data-toggle="tab" style="color:orangered">@ProductData[i].ProductName</a></li>
                                    }
                                </ul>
                                <hr />
                                <div class="tab-content">
                                    @for (int j = 0; j < ProductData.Count(); j++)
                                    {
                                        totalrevenue = 0;
                                        <div class="tab-pane" id="div_@j">
                                            <div class="clearfix">
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div style="overflow-x: scroll; width: 100%" id="gridContent">
                                                            @{
                                                                WebGrid grid = new WebGrid(Model.Where(x => x.ProductName == @ProductData[j].ProductName), rowsPerPage: 15);
                                                                grid.Pager(WebGridPagerModes.All);

                                                                count = Model.Where(x => x.ProductName == @ProductData[j].ProductName).Count();
                                                                foreach (var ritem in Model.Where(x => x.ProductName == @ProductData[j].ProductName))
                                                                {
                                                                    totalrevenue += Convert.ToInt32(ritem.Revenue);
                                                                }

                                                                var tblId = "table_" + j;
                                                                <input type="hidden" id="hdn_@j" value="@totalrevenue">
                                                            }

                                                            @grid.GetHtml(
                                                                             columns: grid.Columns(

                                                                                  grid.Column("", "#Action", canSort: false,
                                                                             format:
                                                                            @<text>
                                                                                <div style='width:80px;'>
                                                                                    @if (Session["RoleCode"].ToString() == "ADMIN" || Session["RoleCode"].ToString() == "SALES" || Session["RoleCode"].ToString() == "REGIONAL")
                                                                                    {
                                                                                        <button class="btn btn-xs btn-success waves-effect" onclick="navigateToDetail(@item.Id)"><i class="fa fa-pencil-square-o" style="padding-left: 5px;"></i></button>
                                                                                        <button class="btn btn-xs btn-danger waves-effect" onclick="DeleteCourseSalesMaster(@item.Id)"><i class="fa fa-trash-o" style="padding-left: 5px;"></i></button>
                                                                                    }
                                                                                    @if (item.IsConfirm == true)
                                                                                    {
                                                                                        <span class="text-green"><i class="fa fa-circle" style="font-size:12pt; "></i></span>
                                                                                    }
                                                                                    else if (item.IsDrop == true)
                                                                                    {
                                                                                        <span class="text-red"><i class="fa fa-circle" style="font-size:12pt;"></i></span>
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <span class="text-gray"><i class="fa fa-circle" style="font-size:12pt;"></i></span>
                                                                                    }
                                                                                </div>
                                                                            </text>),

                                                                             grid.Column("CountryName", "Country", canSort: true),
                                                                             grid.Column("ProductName", "Product Name", canSort: true,
                                                                             format:
                                                                            @<text>
                                                                                <div style='width:110px;'>
                                                                                    @item.ProductName
                                                                                </div>
                                                                            </text>),
                                                                                 grid.Column("CourseName", "Course Name", canSort: true,
                                                                             format:
                                                                            @<text>
                                                                                <div style='width:300px;'>
                                                                                    <span class="center">@item.CourseName</span>
                                                                                </div>
                                                                            </text>, style: ""),
                                                                             grid.Column("NoOfDays", "No Of Days", canSort: true,
                                                                             format:
                                                                            @<text>
                                                                                <div style='width:80px;'>
                                                                                    @item.NoOfDays
                                                                                </div>
                                                                            </text>, style: "center"),
                                                                             grid.Column("Month", "Month", format: @<text>
                                                                                    @GetMonthById(item.Month == null ? 0 : item.Month) </text>, canSort: true),
                                                                             grid.Column("StartDate", "Start Dt", format:
                                                                            @<text>
                                                                                <div style='width:90px;'>
                                                                                    @(item.StartDate == null ? null : item.StartDate.ToString("dd/MM/yyyy"))
                                                                                </div>
                                                                            </text>, style: ""),
                                                                             grid.Column("EndDate", "End Dt", format: @<text>
                                                                                    <div style='width:90px;'>
                                                                                        @(item.EndDate == null ? null : item.EndDate.ToString("dd/MM/yyyy"))
                                                                                    </div>
                                                                            </text>, canSort: true, style: ""),

                                                                             grid.Column("MinimumReg", "Min. Reg", canSort: true,
                                                                             format:
                                                                            @<text>
                                                                                <div style='width:60px;'>
                                                                                    @item.MinimumReg
                                                                                </div>
                                                                            </text>, style: "center"),

                                                                             grid.Column("LeadsOnHead", "Leads on hand",
                                                                             format:
                                                                            @<text>
                                                                                <div style='width:110px;'>
                                                                                    @if (string.IsNullOrWhiteSpace(item.LeadsOnHeadRemarks))
                                                                                    {
                                                                                        <span>@item.LeadsOnHead</span>
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <a style="cursor:pointer;text-decoration:underline;">
                                                                                            <span onmouseover="mouseover(this)" onmouseout="mouseleave(this)" data-placement="top" data-toggle="popover" data-html="true" data-title="Leads on hand Details" data-content="@CheckString(item.LeadsOnHeadRemarks)" data-original-title="" title="">@item.LeadsOnHead</span>
                                                                                        </a>
                                                                                    }
                                                                                </div>
                                                                            </text>, canSort: true, style: "center LeadsOnHead"),
                                                                             grid.Column("Registered", "Registered",
                                                                                     format:
                                                                                    @<text>
                                                                                        @if (string.IsNullOrWhiteSpace(item.RegisteredRemarks))
                                                                                        {
                                                                                            <span>@item.Registered</span>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <a style="cursor:pointer;text-decoration:underline;">
                                                                                                <span data-placement="top" data-toggle="popover" data-html="true" data-title="Leads on hand Details" data-content="@CheckString(item.RegisteredRemarks)"
                                                                                                      onmouseover="mouseover(this)" onmouseout="mouseleave(this)" data-original-title="" title="">@item.Registered</span>
                                                                                                </a>
                                                                                        }
                                                                                    </text>, canSort: true, style: "center"),

                                                                             grid.Column("AvailableSeats", "Avl. Seats", canSort: true,
                                                                                     format:
                                                                                    @<text>
                                                                                        <div style='width:70px;'>
                                                                                            @item.AvailableSeats
                                                                                        </div>
                                                                                    </text>, style: "center"),

                                                                             grid.Column("RegClosingDate", "Reg. Closing Dt.", canSort: true,
                                                                                     format:
                                                                                    @<text>
                                                                                        <div style='width:110px;'>
                                                                                            @(item.RegClosingDate == null ? null : item.RegClosingDate.ToString("dd/MM/yyyy"))
                                                                                        </div>
                                                                                    </text>, style: "center"),
                                                                                 grid.Column("Revenue", "Revenue", canSort: true,
                                                                                  format:
                                                                                @<text>
                                                                                    <div style='width:80px;'>
                                                                                        <span class="">
                                                                                            @ConvertToInt64dollar(item.Revenue)
                                                                                        </span>
                                                                                    </div>
                                                                                </text>, style: "center")),
                                                                         tableStyle: "table tblCss", htmlAttributes: new { id = tblId })
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div class="pull-right css10">@grid.PagerList(mode: WebGridPagerModes.All, paginationStyle: "pagination pagination-sm")</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                                                }

                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>


@using (Html.BeginForm("DeleteCourseSalesMaster", "Master", FormMethod.Post, new { id = "frmDelete", name = "frmDelete" }))
{
    <input type="hidden" id="id" name="id" />
    <input type="hidden" id="month" name="month" />
    <input type="hidden" id="year" name="year" />
}
@section SectionScripts{
    <script type="text/javascript">
        $(function () {
            $("#div_0").addClass('active');
            $("#li_0").addClass('active');
            $('#liRegionalLeads').addClass('active');
        });

        $(document).ready(function () {
            var tbls = $('.tblCss');
            $.each(tbls, function (index, item) {
                var totalRevenue = '$ ' + $('#hdn_' + index).val();
                $('#table_' + index + ' tbody').append('<tr class="bordertop"><td>Summary</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td class="center">' + totalRevenue + '</td><td>');
            });
        });

        function navigateToDetail(id) {
            var month = $('#Month').val();
            var year = $('#Year').val();
            location.href = '@Url.Content("~/Master/CourseSalesMaster?id=")'+id+'&month=' + month + '&year=' + year;
        }

         function ChangeMonth() {
            window.location = '@Url.Action("CourseSalesMasterList", "Master", new { month = "", year = "" })' + '?month=' + $('#Month').val() + "&year=" + $('#Year').val();
        };

        function DeleteCourseSalesMaster(Id) {
            swal({
                title: "Are you sure?",
                text: "Do you want delete?",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-danger",
                confirmButtonText: "Yes, delete it!",
                closeOnConfirm: false
            },
                function () {
                    $('#id').val(Id);
                    $('#month').val($('#Month').val());
                    $('#year').val($('#Year').val());
                    $('#frmDelete').submit();
                    swal("Deleted!", "Your Regional Leads record has been deleted.", "success");

                });
        }

        function mouseleave(el) {
            $(el).popover("hide");
        }

        function mouseover(el) {
            $(el).popover("show");
        }
    </script>
}